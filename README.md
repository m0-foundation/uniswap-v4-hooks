# Uniswap V4 Hooks

This repository contains the Uniswap V4 hook contracts built by M0 Labs for the M0 project.

## Hooks

### Tick Range hook

#### Overview

This hook restricts both liquidity provision and token swaps to a specific tick range, bounded by lower and upper tick values.

This feature is particularly useful for stable pairs that want to prevent their pool's liquidity from becoming unbalanced.

#### Architecture

_BaseTickRangeHook_ is an abstract contract that other hooks can inherit from to restrict swaps and liquidity provision.

It inherits from OpenZeppelin’s AccessControl and allows an admin to manage one role:

- manager role - address that manages the hook and sets the different parameters

The deployer sets the tick range during deployment, and the hook manager can modify it at any time.

Liquidity providers can only add liquidity between the lower and upper tick values.

Liquidity providers may be unable to add liquidity to their positions if the tick range has been updated since they first created their position. They are able to remove their liquidity at any time, even if not inside the current tick range.

### Allowlist hook

#### Overview

The contract maintains two separate allowlists—one for swappers and one for liquidity providers—to restrict which addresses can interact with the pool.

It also inherits from the Tick Range hook contract to restrict liquidity provision within a specific tick range.

[Predicate](https://docs.predicate.io/essentials/introduction) is used to perform ongoing compliance checks for addresses on the swappers allowlist.

#### Architecture

Inherits from the _BaseTickRangeHook_ abstract contract and its functionalities.

Inherits from the _PredicateClient_ to perform Predicate checks when swapping.

Both allowlists and the Predicate check are enabled by default upon deployment and can be disabled later by the hook manager.

## Development

### Installation

You may have to install the following tools to use this repository:

- [Foundry](https://github.com/foundry-rs/foundry) to compile and test contracts
- [lcov](https://github.com/linux-test-project/lcov) to generate the code coverage report
- [slither](https://github.com/crytic/slither) to static analyze contracts

Install dependencies:

```bash
npm i
```

### Env

Copy `.env` and write down the env variables needed to run this project.

```bash
cp .env.example .env
```

### Compile

Run the following command to compile the contracts:

```bash
npm run compile
```

### Coverage

Forge is used for coverage, run it with:

```bash
npm run coverage
```

You can then consult the report by opening `coverage/index.html`:

```bash
open coverage/index.html
```

### Test

To run all tests:

```bash
npm test
```

Run test that matches a test contract:

```bash
forge test --mc <test-contract-name>
```

Test a specific test case:

```bash
forge test --mt <test-case-name>
```

To run slither:

```bash
npm run slither
```

### Code quality

[Husky](https://typicode.github.io/husky/#/) is used to run [lint-staged](https://github.com/okonet/lint-staged) and tests when committing.

[Prettier](https://prettier.io) is used to format code. Use it by running:

```bash
npm run prettier
```

[Solhint](https://protofire.github.io/solhint/) is used to lint Solidity files. Run it with:

```bash
npm run solhint
```

To fix solhint errors, run:

```bash
npm run solhint-fix
```

### CI

The following Github Actions workflow are setup to run on push and pull requests:

- [.github/workflows/coverage.yml](.github/workflows/coverage.yml)
- [.github/workflows/test-gas.yml](.github/workflows/test-gas.yml)

It will build the contracts and run the test coverage, as well as a gas report.

The coverage report will be displayed in the PR by [github-actions-report-lcov](https://github.com/zgosalvez/github-actions-report-lcov) and the gas report by [foundry-gas-diff](https://github.com/Rubilmax/foundry-gas-diff).

For the workflows to work, you will need to setup the `MNEMONIC_FOR_TESTS` and `MAINNET_RPC_URL` repository secrets in the settings of your Github repository.

Some additional workflows are available if you wish to add fuzz, integration and invariant tests:

- [.github/workflows/test-fuzz.yml](.github/workflows/test-fuzz.yml)
- [.github/workflows/test-integration.yml](.github/workflows/test-integration.yml)
- [.github/workflows/test-invariant.yml](.github/workflows/test-invariant.yml)

You will need to uncomment them to activate them.

### Documentation

The documentation can be generated by running:

```bash
npm run doc
```

It will run a server on port 4000, you can then access the documentation by opening [http://localhost:4000](http://localhost:4000).

## Deployment

### Build

To compile the contracts for production, run:

```bash
npm run build
```

### Deploy

#### Local

Open a new terminal window and run [anvil](https://book.getfoundry.sh/reference/anvil/) to start a local chain:

```bash
anvil --fork-url <MAINNET_RPC_URL> --chain-id 31337
```

Use one of the following commands to deploy the different hooks and pools to the local chain:

```bash
npm run deploy-allowlist-hook-local
npm run deploy-allowlist-hook-and-pool-local
npm run deploy-tick-range-hook-local
npm run deploy-tick-range-hook-and-pool-local
```

#### Ethereum

To deploy the Allowlist Hook and Pool to Ethereum Mainnet, run:

```bash
npm run deploy-allowlist-hook-and-pool-ethereum
```

### Manage Uniswap Pool

#### Local

Run the following command to create a liquidity position:

```bash
npm run create-liquidity-position-local
```

#### Ethereum

Run the following command to create a liquidity position:

```bash
npm run create-liquidity-position-ethereum
```

## Deployments

| Network          | Hook Name      | Hook Address                                                                                                          | Pool                                                                                                                                    |
| ---------------- | -------------- | --------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------- |
| Ethereum Mainnet | Allowlist Hook | [0xAf53Cb78035A8E0acCe38441793E2648B15B88a0](https://etherscan.io/address/0xAf53Cb78035A8E0acCe38441793E2648B15B88a0) | [wM/USDC - 0% fee](https://app.uniswap.org/explore/pools/ethereum/0x4de849063d9559a699e26463a433c6d29e7570de49209f95295529afee20eb05)   |
| Ethereum Mainnet | TickRange Hook | [0xDe400595199E6Dae55a1bcb742B3Eb249AF00800](https://etherscan.io/address/0xDe400595199E6Dae55a1bcb742B3Eb249AF00800) | [USDC/mUSD - 0% fee](https://app.uniswap.org/explore/pools/ethereum/0x6b3403809baa251f186c546908d6ebdbd5dc52527b2b3f8bc7d4f5a437091b0f) |
